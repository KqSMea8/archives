#!/bin/sh
set -ue
[ "$1" = "" ] && echo "Usage: $0 version" && exit 1

VERSION=$1
DIST_DIR=$(realpath dist)

rm -rf $DIST_DIR
mkdir -p $DIST_DIR

echo "==> Packaging SDK..."
pushd sdk
yarn
yarn pack
mv makestack-*.tgz $DIST_DIR/makestack-sdk-$VERSION.tar.gz
popd

echo "==> Packaging installer..."
pushd installer
yarn
yarn build:macos
yarn build:linux

pushd builds/makestack-installer-darwin-x64
zip -r $DIST_DIR/makestack-installer-$VERSION-macos.zip makestack-installer.app
popd

pushd builds
tar Jcf $DIST_DIR/makestack-installer-$VERSION-linux-x64.tar.xz makestack-installer-linux-x64
popd

popd

echo "==> Packaging Plugins..."
for plugin in runtime plugins/*; do
  ./sdk/bin/makestack build-plugin --plugin-dir $plugin --outfile $DIST_DIR/$(basename $plugin)-$VERSION.plugin.zip
echo
done

echo "==> Building linux..."
cd linux
make prepare
for target in raspberrypi3; do
  make TARGET=$target BUILD=release DOCKER=1
  mv build/$target/makestack-linux-$target.img $DIST_DIR/makestack-linux-$VERSION-$target.img
  rm -rf $DIST_DIR/linux
done

SHASUM="$(cd $DEST_DIR && shasum -a 256 *)"
echo $SHASUM > $DEST_DIR/SHASUM
