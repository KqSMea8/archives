#!/bin/busybox sh

# First, install symbolic links to /busybox into /bin and /sbin.
/bin/busybox mkdir -p /sbin /bin
/bin/busybox --install -s


cd /
mkdir -p sys proc tmp app
mount -t sysfs    sysfs    /sys
mount -t securityfs securityfs /sys/kernel/security
mount -t proc     proc     /proc
mount -t devtmpfs devtmpfs /dev

cat <<"EOF"
 __  __       _        ____  _             _       _     _
|  \/  | __ _| | _____/ ___|| |_ __ _  ___| | __  | |   (_)_ __  _   ___  __
| |\/| |/ _` | |/ / _ \___ \| __/ _` |/ __| |/ /  | |   | | '_ \| | | \ \/ /
| |  | | (_| |   <  __/___) | || (_| | (__|   <   | |___| | | | | |_| |>  <
|_|  |_|\__,_|_|\_\___|____/ \__\__,_|\___|_|\_\  |_____|_|_| |_|\__,_/_/\_\

EOF

for interface in $(echo /sys/class/net/* | xargs -n1 basename); do
    [ "$interface" = "lo" ] && continue
    [ "$interface" = "irlan0" ] && continue

    ip link set $interface up
    udhcpc -i $interface -s /etc/udhcpc.script
done

root=$(egrep -o "root=([^ ]+)" /proc/cmdline | awk -F= '{print $2}')
[ "$root" = "" ] || echo "Error: root is not speicifed in /proc/cmdline" > /dev/stderr
mkdir /boot
mount $root /boot

. /boot/config.sh
hostname makestack-linux

if [ "$DISABLE_APPARMOR" = "yes" ]; then
  apparmor_parser -C -r /etc/apparmor.d/*
else
  apparmor_parser -r /etc/apparmor.d/*
fi

ntpd -p 1.pool.ntp.org

echo "Boot time: $(awk '{print $1}' /proc/uptime) secs"

debug=$(egrep -o "debug" /proc/cmdline)
if [ "$debug" = "" ]; then
    export MAKESTACK_OS_TYPE=linux
    export MAKESTACK_APP_UID=0
    export MAKESTACK_APP_GID=0
    echo "Starting MakeStack Supervisor..."
    node /supervisor/supervisor
else
    export MAKESTACK_DEBUG_MODE=1
    echo "TODO: run tests!"
fi

echo "*** something went wrong, rebooting in 10 seconds..."
sleep 10
reboot -f
