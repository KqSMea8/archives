#!/bin/busybox sh

# First, install symbolic links to /busybox into /bin and /sbin.
/bin/busybox mkdir -p /sbin /bin
/bin/busybox --install -s


cd /
mkdir -p sys proc tmp app
mount -t sysfs    sysfs    /sys
mount -t securityfs securityfs /sys/kernel/security
mount -t proc     proc     /proc
mount -t devtmpfs devtmpfs /dev

cat <<"EOF"
 __  __       _        ____  _             _       _     _
|  \/  | __ _| | _____/ ___|| |_ __ _  ___| | __  | |   (_)_ __  _   ___  __
| |\/| |/ _` | |/ / _ \___ \| __/ _` |/ __| |/ /  | |   | | '_ \| | | \ \/ /
| |  | | (_| |   <  __/___) | || (_| | (__|   <   | |___| | | | | |_| |>  <
|_|  |_|\__,_|_|\_\___|____/ \__\__,_|\___|_|\_\  |_____|_|_| |_|\__,_/_/\_\

EOF

root=$(egrep -o "root=([^ ]+)" /proc/cmdline | awk -F= '{print $2}')
[ "$root" = "" ] || echo "Error: root is not speicifed in /proc/cmdline" > /dev/stderr
mkdir /boot
mount $root /boot

. /boot/config.sh
hostname makestack-linux

start_daemon() {
  script=$1
  backoff=1
  while :; do
    sh -c "$script"
    exitcode=$?
    if [ $exitcode -eq 0 ] ;then
      echo "'$script' exited with $exitcode. Stopping the daemon..."
      break
    fi

    echo "*** '$script' exited with $exitcode. Restarting in $backoff seconds..."
    sleep $backoff
    backoff=$(($backoff << 1))
  done
}

if [ "$DISABLE_APPARMOR" = "yes" ]; then
  apparmor_parser -C -r /etc/apparmor.d/*
else
  apparmor_parser -r /etc/apparmor.d/*
fi

# Initialize random seed.
RANDSEED_FILE=/boot/randseed
RANDSEED_SIZE=512
if [ -f "$RANDSEED_FILE" ]; then
  echo "*** Feeding random seed"
  cat "$RANDSEED_FILE" > /dev/urandom
fi

if [ "$MAKESTACK_NETWORK_ADAPTER" = "http" ]; then
  for interface in $(echo /sys/class/net/* | xargs -n1 basename); do
    [ "$interface" = "lo" ] && continue
    [ "$interface" = "irlan0" ] && continue

    echo "*** Initializing $interface"
    ip link set $interface up
    start_daemon "udhcpc -f -i $interface -s /etc/udhcpc.script" &
  done
fi

if [ "$MAKESTACK_NETWORK_ADAPTER" = "http" ]; then
  start_daemon "ntpd -n -p 1.pool.ntp.org" &
fi

echo "*** Boot time: $(awk '{print $1}' /proc/uptime) secs"

export MAKESTACK_APP_UID=0
export MAKESTACK_APP_GID=0
echo "*** Starting MakeStack Supervisor..."

# Don't append `&'. start_daemon must return if the supervisor exited with 0 to reboot.`
start_daemon "node /supervisor/supervisor"

echo "*** Saving random seed..."
dd if=/dev/urandom of=$RANDSEED_FILE bs=$RANDSEED_SIZE count=1

echo "*** Rebooting in 10 seconds..."
sleep 10
reboot -f
