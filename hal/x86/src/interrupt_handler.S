#include "x86_asm.h"
.text
.code64


/*
 *
 *  system call
 *
 */
.globl C_SYMBOL(x86_asm_syscall_handler)
.extern kernel_syscall
C_SYMBOL(x86_asm_syscall_handler):
  /* the return address is stored in RCX */

  /*
   *  FIXME: prepare a *kernel* stack for each thread
   */

  push rcx
  push rdi
  push rsi
  push r12
  push r13
  push r14
  push r15

  /* system call arguments are RDI, RSI, RDX, R9 in order */
  mov   rcx, r9      // r3
  lea   r8,  [rsp-8] // ret
  sub   rsp, 8

  call  kernel_syscall

  mov   rbx, [rsp] // ret
  add   rsp, 8

  pop  r15
  pop  r14
  pop  r13
  pop  r12
  pop  rsi
  pop  rdi
  pop  rcx
  sysretq

/*
 *
 *  the handler for unregistered interrupts
 *
 */
.globl  x86_asm_int_handler_unregistered
.extern x86_ack_interrupt
x86_asm_int_handler_unregistered:
  cli
  SAVE_REGS
  call x86_ack_interrupt
  RESTORE_REGS
  iretq


/*
 *
 *  exception handler
 *
 */
.macro EXP_HANDLER_W_ERRCODE num
  .globl  x86_asm_exp_handler\num
  .extern x86_exp_handler\num
  x86_asm_exp_handler\num:
    push rax
    mov  rax, [rsp+8]    // get error code and copy it
    mov  [rsp-112], rax  // on the top of stack after
                         // SAVE_REGS
    pop  rax
    add  rsp, 8 // overwrite the error code provided by the CPU
    SAVE_REGS

    sub  rsp, 8 // to get error code copied above
    pop  rsi // error code
    mov  rdi, [rsp+120] // RIP

    call x86_exp_handler\num
 
    RESTORE_REGS
    iretq
.endm


.macro EXP_HANDLER_WO_ERRCODE num
  .globl  x86_asm_exp_handler\num
  .extern x86_exp_handler\num
  x86_asm_exp_handler\num:
    SAVE_REGS

    mov  rdi, [rsp+120] // RIP
    call x86_exp_handler\num

    RESTORE_REGS
    iretq
.endm


/*
 *
 *  interrupt handler
 *
 */
.extern x86_interrupt_handler
.macro INT_HANDLER num
  .globl x86_asm_int_handler\num

  x86_asm_int_handler\num:
    cli
    SAVE_REGS

    mov  rdi, \num
    call x86_interrupt_handler

    RESTORE_REGS
    iretq
.endm


EXP_HANDLER_WO_ERRCODE 0
EXP_HANDLER_WO_ERRCODE 1
EXP_HANDLER_WO_ERRCODE 2 // FIXME: NMI is unusual
EXP_HANDLER_WO_ERRCODE 3
EXP_HANDLER_WO_ERRCODE 4
EXP_HANDLER_WO_ERRCODE 5
EXP_HANDLER_WO_ERRCODE 6
EXP_HANDLER_WO_ERRCODE 7
EXP_HANDLER_W_ERRCODE  8
EXP_HANDLER_WO_ERRCODE 9
EXP_HANDLER_W_ERRCODE  10
EXP_HANDLER_W_ERRCODE  11
EXP_HANDLER_W_ERRCODE  12
EXP_HANDLER_W_ERRCODE  13
EXP_HANDLER_W_ERRCODE  14
EXP_HANDLER_W_ERRCODE  15
EXP_HANDLER_WO_ERRCODE 16
EXP_HANDLER_W_ERRCODE  17
EXP_HANDLER_WO_ERRCODE 18
EXP_HANDLER_WO_ERRCODE 19
EXP_HANDLER_WO_ERRCODE 20

INT_HANDLER 32
INT_HANDLER 33
INT_HANDLER 34
INT_HANDLER 35
INT_HANDLER 36
INT_HANDLER 37
INT_HANDLER 38
INT_HANDLER 39
INT_HANDLER 40
INT_HANDLER 41
INT_HANDLER 42
INT_HANDLER 43
INT_HANDLER 44
INT_HANDLER 45
INT_HANDLER 46
INT_HANDLER 47
INT_HANDLER 48
INT_HANDLER 49
INT_HANDLER 50
INT_HANDLER 51
INT_HANDLER 52
INT_HANDLER 53
INT_HANDLER 54
INT_HANDLER 55
INT_HANDLER 56
INT_HANDLER 57
INT_HANDLER 58
INT_HANDLER 59
INT_HANDLER 60
INT_HANDLER 61
INT_HANDLER 62
INT_HANDLER 63
INT_HANDLER 64
INT_HANDLER 65
INT_HANDLER 66
INT_HANDLER 67
INT_HANDLER 68
INT_HANDLER 69
INT_HANDLER 70
INT_HANDLER 71
INT_HANDLER 72
INT_HANDLER 73
INT_HANDLER 74
INT_HANDLER 75
INT_HANDLER 76
INT_HANDLER 77
INT_HANDLER 78
INT_HANDLER 79
INT_HANDLER 80
INT_HANDLER 81
INT_HANDLER 82
INT_HANDLER 83
INT_HANDLER 84
INT_HANDLER 85
INT_HANDLER 86
INT_HANDLER 87
INT_HANDLER 88
INT_HANDLER 89
INT_HANDLER 90
INT_HANDLER 91
INT_HANDLER 92
INT_HANDLER 93
INT_HANDLER 94
INT_HANDLER 95
INT_HANDLER 96
INT_HANDLER 97
INT_HANDLER 98
INT_HANDLER 99
INT_HANDLER 100
INT_HANDLER 101
INT_HANDLER 102
INT_HANDLER 103
INT_HANDLER 104
INT_HANDLER 105
INT_HANDLER 106
INT_HANDLER 107
INT_HANDLER 108
INT_HANDLER 109
INT_HANDLER 110
INT_HANDLER 111
INT_HANDLER 112
INT_HANDLER 113
INT_HANDLER 114
INT_HANDLER 115
INT_HANDLER 116
INT_HANDLER 117
INT_HANDLER 118
INT_HANDLER 119
INT_HANDLER 120
INT_HANDLER 121
INT_HANDLER 122
INT_HANDLER 123
INT_HANDLER 124
INT_HANDLER 125
INT_HANDLER 126
INT_HANDLER 127
INT_HANDLER 128
INT_HANDLER 129
INT_HANDLER 130
INT_HANDLER 131
INT_HANDLER 132
INT_HANDLER 133
INT_HANDLER 134
INT_HANDLER 135
INT_HANDLER 136
INT_HANDLER 137
INT_HANDLER 138
INT_HANDLER 139
INT_HANDLER 140
INT_HANDLER 141
INT_HANDLER 142
INT_HANDLER 143
INT_HANDLER 144
INT_HANDLER 145
INT_HANDLER 146
INT_HANDLER 147
INT_HANDLER 148
INT_HANDLER 149
INT_HANDLER 150
INT_HANDLER 151
INT_HANDLER 152
INT_HANDLER 153
INT_HANDLER 154
INT_HANDLER 155
INT_HANDLER 156
INT_HANDLER 157
INT_HANDLER 158
INT_HANDLER 159
INT_HANDLER 160
INT_HANDLER 161
INT_HANDLER 162
INT_HANDLER 163
INT_HANDLER 164
INT_HANDLER 165
INT_HANDLER 166
INT_HANDLER 167
INT_HANDLER 168
INT_HANDLER 169
INT_HANDLER 170
INT_HANDLER 171
INT_HANDLER 172
INT_HANDLER 173
INT_HANDLER 174
INT_HANDLER 175
INT_HANDLER 176
INT_HANDLER 177
INT_HANDLER 178
INT_HANDLER 179
INT_HANDLER 180
INT_HANDLER 181
INT_HANDLER 182
INT_HANDLER 183
INT_HANDLER 184
INT_HANDLER 185
INT_HANDLER 186
INT_HANDLER 187
INT_HANDLER 188
INT_HANDLER 189
INT_HANDLER 190
INT_HANDLER 191
INT_HANDLER 192
INT_HANDLER 193
INT_HANDLER 194
INT_HANDLER 195
INT_HANDLER 196
INT_HANDLER 197
INT_HANDLER 198
INT_HANDLER 199
INT_HANDLER 200
INT_HANDLER 201
INT_HANDLER 202
INT_HANDLER 203
INT_HANDLER 204
INT_HANDLER 205
INT_HANDLER 206
INT_HANDLER 207
INT_HANDLER 208
INT_HANDLER 209
INT_HANDLER 210
INT_HANDLER 211
INT_HANDLER 212
INT_HANDLER 213
INT_HANDLER 214
INT_HANDLER 215
INT_HANDLER 216
INT_HANDLER 217
INT_HANDLER 218
INT_HANDLER 219
INT_HANDLER 220
INT_HANDLER 221
INT_HANDLER 222
INT_HANDLER 223
INT_HANDLER 224
INT_HANDLER 225
INT_HANDLER 226
INT_HANDLER 227
INT_HANDLER 228
INT_HANDLER 229
INT_HANDLER 230
INT_HANDLER 231
INT_HANDLER 232
INT_HANDLER 233
INT_HANDLER 234
INT_HANDLER 235
INT_HANDLER 236
INT_HANDLER 237
INT_HANDLER 238
INT_HANDLER 239
INT_HANDLER 240
INT_HANDLER 241
INT_HANDLER 242
INT_HANDLER 243
INT_HANDLER 244
INT_HANDLER 245
INT_HANDLER 246
INT_HANDLER 247
INT_HANDLER 248
INT_HANDLER 249
INT_HANDLER 250
INT_HANDLER 251
INT_HANDLER 252
INT_HANDLER 253
INT_HANDLER 254
INT_HANDLER 255

