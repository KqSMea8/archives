#!/usr/bin/env node

/* The image writer would be executed in sudo. Avoid
requiring other stuffs for security. */
if (process.env.IMAGE_WRITER !== undefined) {
  const imageWriter = require('../lib/image_writer')
  imageWriter().catch(error => {
    console.error(error)
    process.exit(1)
  })
} else {
  const chalk = require('chalk')
  const cli = require('../dist/cli')

  cli.run(process.argv).catch(error => {
    const format = (process.stderr.isTTY) ? chalk.bold.red : x => x
    const cmdlineParseErrors = ['WrongNumberOfArgumentError', 'InvalidOptionValueError']

    if (cmdlineParseErrors.includes(error.constructor.name)) {
      process.stderr.write(format(error.message))
    } else if (error.constructor.name === 'FatalError') {
      process.stderr.write(format('Error: ' + error.message) + '\n')
    } else {
      process.stderr.write(format('Error: ' + error.stack) + '\n')
    }
  })
}
